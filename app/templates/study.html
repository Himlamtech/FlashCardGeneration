{% extends "base.html" %}

{% block title %}Study - Flash Card Generation{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <h1 class="card-title text-center mb-4">
            <i class="fas fa-book-reader text-primary me-2"></i>Study Mode
        </h1>
        <p class="lead text-center">Review your flashcards to enhance your learning</p>
    </div>
</div>

{% if flashcards %}
<div class="row justify-content-center mb-5">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Flashcards</h4>
                <div>
                    <button id="shuffle-btn" class="btn btn-light btn-sm">
                        <i class="fas fa-random me-1"></i> Shuffle
                    </button>
                    <div class="btn-group ms-2">
                        <button id="prev-btn" class="btn btn-light btn-sm">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="next-btn" class="btn btn-light btn-sm">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="flashcard-container">
                    <!-- Flashcard content will be inserted here by JavaScript -->
                </div>
            </div>
            <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                <span>Card <span id="current-card">1</span> of <span id="total-cards">{{ flashcards|length }}</span></span>
                <div class="btn-group">
                    <button id="show-answer-btn" class="btn btn-primary">
                        <i class="fas fa-eye me-1"></i> Show Answer
                    </button>
                    <button id="hide-answer-btn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-eye-slash me-1"></i> Hide Answer
                    </button>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-center">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Home
            </a>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-tools me-2"></i>AI Tools</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h5><i class="fas fa-spell-check text-success me-2"></i>Grammar Check</h5>
                    <textarea id="grammar-text" class="form-control mb-2" rows="3" placeholder="Enter text to check grammar..."></textarea>
                    <button id="check-grammar-btn" class="btn btn-sm btn-outline-success">Check Grammar</button>
                    <div id="grammar-result" class="mt-2" style="display: none;"></div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h5><i class="fas fa-language text-primary me-2"></i>Translate</h5>
                    <div class="input-group mb-2">
                        <select id="source-lang" class="form-select">
                            <option value="english" selected>English</option>
                            <option value="vietnamese">Vietnamese</option>
                            <option value="spanish">Spanish</option>
                            <option value="french">French</option>
                            <option value="german">German</option>
                        </select>
                        <span class="input-group-text">to</span>
                        <select id="target-lang" class="form-select">
                            <option value="english">English</option>
                            <option value="vietnamese" selected>Vietnamese</option>
                            <option value="spanish">Spanish</option>
                            <option value="french">French</option>
                            <option value="german">German</option>
                        </select>
                    </div>
                    <textarea id="translate-text" class="form-control mb-2" rows="3" placeholder="Enter text to translate..."></textarea>
                    <button id="translate-btn" class="btn btn-sm btn-outline-primary">Translate</button>
                    <div id="translate-result" class="mt-2" style="display: none;"></div>
                </div>
                
                <hr>
                
                <div>
                    <h5><i class="fas fa-file-alt text-info me-2"></i>Summarize</h5>
                    <textarea id="summarize-text" class="form-control mb-2" rows="3" placeholder="Enter text to summarize..."></textarea>
                    <button id="summarize-btn" class="btn btn-sm btn-outline-info">Summarize</button>
                    <div id="summarize-result" class="mt-2" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle me-2"></i>You don't have any flashcards to study. 
    <a href="/create" class="alert-link">Create your first flashcard</a>.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Flashcard data
        const flashcards = {{ flashcards|tojson }};
        let currentCardIndex = 0;
        let showingAnswer = false;
        
        // Initial render
        if (flashcards.length > 0) {
            renderCard(currentCardIndex);
        }
        
        // Functions to manage the flashcard display
        function renderCard(index) {
            const card = flashcards[index];
            $('#current-card').text(index + 1);
            
            let html = `
                <div class="flashcard p-4">
                    <div class="flashcard-front">
                        <h2 class="text-center mb-3">${card.word}</h2>
                        <p class="text-center text-muted">${card.language}</p>
                    </div>
                    <div class="flashcard-back" style="display: none;">
                        <div class="mb-3">
                            <h5><i class="fas fa-volume-up text-primary me-2"></i>Pronunciation:</h5>
                            <p>${card.pronunciation || 'Not available'}</p>
                        </div>
                        <div class="mb-3">
                            <h5><i class="fas fa-language text-primary me-2"></i>Translations:</h5>
                            <p>${card.translations || 'Not available'}</p>
                        </div>
                        <div>
                            <h5><i class="fas fa-quote-left text-primary me-2"></i>Examples:</h5>
                            <ul class="list-group list-group-flush">`;
            
            if (card.examples) {
                const examples = card.examples.split(';');
                examples.forEach(example => {
                    if (example.trim()) {
                        html += `<li class="list-group-item">${example.trim()}</li>`;
                    }
                });
            } else {
                html += `<li class="list-group-item">No examples available</li>`;
            }
            
            html += `
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            $('#flashcard-container').html(html);
            showingAnswer = false;
            $('#show-answer-btn').show();
            $('#hide-answer-btn').hide();
        }
        
        // Button event handlers
        $('#next-btn').click(function() {
            if (flashcards.length === 0) return;
            
            currentCardIndex = (currentCardIndex + 1) % flashcards.length;
            renderCard(currentCardIndex);
        });
        
        $('#prev-btn').click(function() {
            if (flashcards.length === 0) return;
            
            currentCardIndex = (currentCardIndex - 1 + flashcards.length) % flashcards.length;
            renderCard(currentCardIndex);
        });
        
        $('#shuffle-btn').click(function() {
            if (flashcards.length <= 1) return;
            
            // Fisher-Yates shuffle algorithm
            for (let i = flashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
            }
            
            currentCardIndex = 0;
            renderCard(currentCardIndex);
        });
        
        $('#show-answer-btn').click(function() {
            $('.flashcard-back').show();
            $(this).hide();
            $('#hide-answer-btn').show();
            showingAnswer = true;
        });
        
        $('#hide-answer-btn').click(function() {
            $('.flashcard-back').hide();
            $(this).hide();
            $('#show-answer-btn').show();
            showingAnswer = false;
        });
        
        // AI Tool Functions
        $('#check-grammar-btn').click(function() {
            const text = $('#grammar-text').val().trim();
            if (!text) return;
            
            $(this).prop('disabled', true);
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...');
            
            $.ajax({
                url: '/api/check-grammar',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ text: text }),
                success: function(data) {
                    let html = `
                        <div class="alert alert-success">
                            <h6>Corrected Text:</h6>
                            <p>${data.corrected_text}</p>
                        </div>
                    `;
                    
                    if (data.errors && data.errors !== "No errors found") {
                        html += `
                            <div class="alert alert-warning">
                                <h6>Errors Found:</h6>
                                <ul>
                        `;
                        
                        const errors = data.errors.split(';');
                        errors.forEach(error => {
                            if (error.trim()) {
                                html += `<li>${error.trim()}</li>`;
                            }
                        });
                        
                        html += `
                                </ul>
                            </div>
                        `;
                    }
                    
                    $('#grammar-result').html(html).show();
                },
                error: function(err) {
                    $('#grammar-result').html(`
                        <div class="alert alert-danger">
                            Error: ${err.responseJSON?.detail || 'Could not check grammar'}
                        </div>
                    `).show();
                },
                complete: function() {
                    $('#check-grammar-btn').prop('disabled', false);
                    $('#check-grammar-btn').html('Check Grammar');
                }
            });
        });
        
        $('#translate-btn').click(function() {
            const text = $('#translate-text').val().trim();
            if (!text) return;
            
            const sourceLang = $('#source-lang').val();
            const targetLang = $('#target-lang').val();
            
            $(this).prop('disabled', true);
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Translating...');
            
            $.ajax({
                url: '/api/translate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    text: text,
                    source_lang: sourceLang,
                    target_lang: targetLang
                }),
                success: function(data) {
                    $('#translate-result').html(`
                        <div class="alert alert-success">
                            <h6>Translation:</h6>
                            <p>${data.translated_text}</p>
                        </div>
                    `).show();
                },
                error: function(err) {
                    $('#translate-result').html(`
                        <div class="alert alert-danger">
                            Error: ${err.responseJSON?.detail || 'Could not translate text'}
                        </div>
                    `).show();
                },
                complete: function() {
                    $('#translate-btn').prop('disabled', false);
                    $('#translate-btn').html('Translate');
                }
            });
        });
        
        $('#summarize-btn').click(function() {
            const text = $('#summarize-text').val().trim();
            if (!text) return;
            
            $(this).prop('disabled', true);
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Summarizing...');
            
            $.ajax({
                url: '/api/summarize',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ text: text }),
                success: function(data) {
                    $('#summarize-result').html(`
                        <div class="alert alert-info">
                            <h6>Summary:</h6>
                            <p>${data.summary}</p>
                        </div>
                    `).show();
                },
                error: function(err) {
                    $('#summarize-result').html(`
                        <div class="alert alert-danger">
                            Error: ${err.responseJSON?.detail || 'Could not summarize text'}
                        </div>
                    `).show();
                },
                complete: function() {
                    $('#summarize-btn').prop('disabled', false);
                    $('#summarize-btn').html('Summarize');
                }
            });
        });
    });
</script>
{% endblock %} 