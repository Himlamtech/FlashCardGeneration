{% extends "base.html" %}

{% block title %}Chatbot Assistant - FlashCard Generation{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4 fade-in-element">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0"><i class="bi bi-robot me-2"></i>FlashCard Assistant</h2>
                </div>
                <div class="card-body">
                    <p class="card-text">Chat with our AI assistant to get help with creating flashcards, studying, or using any of our tools. Ask questions about how to use the application or get study tips!</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3 mb-4 fade-in-element">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Quick Help</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">You can ask the assistant about:</p>
                    <ul class="quick-topics">
                        <li>Creating flashcards</li>
                        <li>Study techniques</li>
                        <li>Using AI tools</li>
                        <li>Editing cards</li>
                        <li>Memory tips</li>
                    </ul>
                    
                    <div class="mt-3">
                        <p class="mb-2">Quick questions:</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary quick-question" data-question="How do I create a flashcard?">
                                How do I create a flashcard?
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-question" data-question="Give me a study tip">
                                Give me a study tip
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-question" data-question="What AI tools are available?">
                                What AI tools are available?
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-question" data-question="How to use translation?">
                                How to use translation?
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Chat History</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="chatHistory">
                        <li class="list-group-item text-muted text-center">No previous chats</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-9 fade-in-element">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-chat-dots me-2"></i>Chat
                    </div>
                    <button class="btn btn-sm btn-outline-light" id="clearChat">
                        <i class="bi bi-trash me-1"></i>Clear Chat
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="chat-messages" id="chatbotFullMessages">
                        <div class="chat-message chat-message-bot">
                            <div class="chat-message-content">
                                <p>ðŸ‘‹ Hi there! I'm your FlashCard Assistant. How can I help you today?</p>
                                <p>You can ask me about creating flashcards, studying techniques, or how to use our AI tools.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" id="chatbotFullInput" class="form-control" placeholder="Type your message here..." autocomplete="off">
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    
    .chat-message {
        margin-bottom: 1rem;
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
        animation: fadeInUp 0.3s ease;
    }
    
    .chat-message-bot {
        background-color: #e6f2ff;
        color: #333;
        border-top-left-radius: 0.3rem;
        align-self: flex-start;
        margin-right: auto;
    }
    
    .chat-message-user {
        background-color: var(--primary-color);
        color: white;
        border-top-right-radius: 0.3rem;
        align-self: flex-end;
        margin-left: auto;
        margin-right: 0;
    }
    
    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }
    
    .quick-topics {
        padding-left: 1.2rem;
    }
    
    .quick-topics li {
        margin-bottom: 0.5rem;
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        background-color: #e6f2ff;
        border-radius: 18px;
        width: fit-content;
    }
    
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #b6b6b6;
        border-radius: 50%;
        display: inline-block;
        margin: 0 3px;
        opacity: 0.6;
    }
    
    .typing-indicator span:nth-child(1) {
        animation: typingBounce 1s infinite 0s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation: typingBounce 1s infinite 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation: typingBounce 1s infinite 0.4s;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get DOM elements
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatbotFullInput');
        const messagesContainer = document.getElementById('chatbotFullMessages');
        const clearChatButton = document.getElementById('clearChat');
        const quickQuestionButtons = document.querySelectorAll('.quick-question');
        const chatHistory = document.getElementById('chatHistory');
        
        // Set up chat history from localStorage if available
        setupChatHistory();
        
        // Handle chat form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            
            if (message) {
                // Add user message to chat
                addUserMessage(message);
                
                // Clear input
                chatInput.value = '';
                
                // Save to chat history
                saveToHistory(message);
                
                // Show typing indicator
                showTypingIndicator();
                
                // Process user message and generate response
                setTimeout(() => {
                    hideTypingIndicator();
                    processChatbotResponse(message);
                }, 1000 + Math.random() * 1000); // Random delay for realism
            }
        });
        
        // Clear chat button
        clearChatButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the chat?')) {
                messagesContainer.innerHTML = '';
                addBotMessage("ðŸ‘‹ Hi there! I'm your FlashCard Assistant. How can I help you today?");
            }
        });
        
        // Quick question buttons
        quickQuestionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const question = this.getAttribute('data-question');
                chatInput.value = question;
                chatForm.dispatchEvent(new Event('submit'));
            });
        });
        
        // Add a user message to the chat
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', 'chat-message-user');
            
            const messageContent = document.createElement('div');
            messageContent.classList.add('chat-message-content');
            messageContent.textContent = message;
            
            messageElement.appendChild(messageContent);
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Add a bot message to the chat
        function addBotMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', 'chat-message-bot');
            
            const messageContent = document.createElement('div');
            messageContent.classList.add('chat-message-content');
            messageContent.innerHTML = message;
            
            messageElement.appendChild(messageContent);
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typingIndicator';
            typingIndicator.classList.add('chat-message', 'chat-message-bot', 'typing-indicator');
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(typingIndicator);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Scroll the chat to the bottom
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Process user message and generate a response
        function processChatbotResponse(message) {
            // Convert to lowercase for easier comparison
            const lowerMessage = message.toLowerCase();
            
            // Check for keywords and respond accordingly
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                addBotMessage("Hello! How can I assist you with your flashcards today?");
            }
            else if (lowerMessage.includes('create') || lowerMessage.includes('new card') || lowerMessage.includes('make card')) {
                addBotMessage(`
                    <p>To create a new flashcard:</p>
                    <ol>
                        <li>Click on the <b>Create Cards</b> link in the sidebar</li>
                        <li>Fill in the question (front side) and answer (back side)</li>
                        <li>Optionally add tags to organize your cards</li>
                        <li>Click the Save Flashcard button</li>
                    </ol>
                    <p>You can also use our AI tools to help generate content for your flashcards.</p>
                    <a href='/create' class='btn btn-sm btn-primary mt-2'>Create Flashcard Now</a>
                `);
            }
            else if (lowerMessage.includes('study') || lowerMessage.includes('review')) {
                addBotMessage(`
                    <p>To study your flashcards:</p>
                    <ol>
                        <li>Click on the <b>Study</b> link in the sidebar</li>
                        <li>Flip through the cards by clicking on them</li>
                        <li>Rate your knowledge by clicking Easy, Medium, or Hard</li>
                        <li>Cards you find difficult will appear more frequently</li>
                    </ol>
                    <p>Regular study sessions are key to effective learning!</p>
                    <a href='/study' class='btn btn-sm btn-primary mt-2'>Start Studying Now</a>
                `);
            }
            else if (lowerMessage.includes('delete')) {
                addBotMessage(`
                    <p>To delete a flashcard:</p>
                    <ol>
                        <li>Go to the home page</li>
                        <li>Find the flashcard you want to remove</li>
                        <li>Click the Delete button on that card</li>
                        <li>Confirm the deletion in the popup dialog</li>
                    </ol>
                    <p>Note: This action cannot be undone, so be sure before deleting!</p>
                    <a href='/' class='btn btn-sm btn-primary mt-2'>Go to Home Page</a>
                `);
            }
            else if (lowerMessage.includes('edit') || lowerMessage.includes('change')) {
                addBotMessage(`
                    <p>To edit a flashcard:</p>
                    <ol>
                        <li>Go to the home page</li>
                        <li>Find the card you want to modify</li>
                        <li>Click the Edit button on that card</li>
                        <li>Make your changes in the form</li>
                        <li>Click the Save button to update the card</li>
                    </ol>
                    <a href='/' class='btn btn-sm btn-primary mt-2'>Go to Home Page</a>
                `);
            }
            else if (lowerMessage.includes('grammar') || lowerMessage.includes('check grammar')) {
                addBotMessage(`
                    <p>Our Grammar Check tool helps you improve your writing by identifying grammar, spelling, and style issues.</p>
                    <p>To use it:</p>
                    <ol>
                        <li>Go to the Grammar Check page</li>
                        <li>Enter your text in the input field</li>
                        <li>Click "Check Grammar"</li>
                        <li>Review the corrected text</li>
                        <li>You can copy the corrected text or create a flashcard from it</li>
                    </ol>
                    <a href='/grammar' class='btn btn-sm btn-primary mt-2'>Go to Grammar Check</a>
                `);
            }
            else if (lowerMessage.includes('translate') || lowerMessage.includes('translation')) {
                addBotMessage(`
                    <p>Our Translation tool allows you to translate text between different languages. It's perfect for language learning!</p>
                    <p>To use it:</p>
                    <ol>
                        <li>Go to the Translation page</li>
                        <li>Enter the text you want to translate</li>
                        <li>Select the source and target languages</li>
                        <li>Click "Translate"</li>
                        <li>You can copy the translation or create a flashcard from it</li>
                    </ol>
                    <a href='/translate' class='btn btn-sm btn-primary mt-2'>Go to Translation</a>
                `);
            }
            else if (lowerMessage.includes('summarize') || lowerMessage.includes('summary')) {
                addBotMessage(`
                    <p>Our Summarize tool helps you condense long text into concise summaries.</p>
                    <p>To use it:</p>
                    <ol>
                        <li>Go to the Summarize page</li>
                        <li>Paste your long text in the input field</li>
                        <li>Select the desired summary length and style</li>
                        <li>Click "Summarize"</li>
                        <li>Review the summary and key points</li>
                        <li>You can copy the summary or create a flashcard from it</li>
                    </ol>
                    <a href='/summarize' class='btn btn-sm btn-primary mt-2'>Go to Summarize</a>
                `);
            }
            else if (lowerMessage.includes('tip') || lowerMessage.includes('advice')) {
                showRandomTip();
            }
            else if (lowerMessage.includes('tool') || lowerMessage.includes('ai tool')) {
                addBotMessage(`
                    <p>We offer several AI tools to enhance your learning experience:</p>
                    <ul>
                        <li><b>Grammar Check</b> - Improve your writing by fixing grammar and spelling</li>
                        <li><b>Translation</b> - Translate text between different languages</li>
                        <li><b>Summarize</b> - Condense long texts into concise summaries</li>
                        <li><b>AI Assistant</b> (that's me!) - Help with using the app and study tips</li>
                    </ul>
                    <p>You can access all these tools from the sidebar navigation.</p>
                `);
            }
            else if (lowerMessage.includes('help') || lowerMessage.includes('how to')) {
                showHelpGuide();
            }
            else if (lowerMessage.includes('memory') || lowerMessage.includes('technique') || lowerMessage.includes('memorize')) {
                showMemoryTechniques();
            }
            else {
                // General response for any other query
                addBotMessage(`
                    <p>I'm here to help with your flashcard needs. Would you like assistance with:</p>
                    <ul>
                        <li>Creating flashcards</li>
                        <li>Studying techniques</li>
                        <li>Using our AI tools</li>
                        <li>Memory techniques</li>
                        <li>Something else?</li>
                    </ul>
                    <p>Just let me know what you need help with!</p>
                `);
            }
        }
        
        // Show help guide with app instructions
        function showHelpGuide() {
            addBotMessage(`
                <h6 class="mb-2">FlashCard App Guide:</h6>
                <ul>
                    <li><b>Create flashcards</b> - Go to Create Cards page and fill out the form</li>
                    <li><b>Study</b> - Go to Study page and flip through your cards</li>
                    <li><b>Edit/Delete</b> - Manage your cards from the home page</li>
                    <li><b>AI Tools</b>:
                        <ul>
                            <li><b>Grammar Check</b> - Fix grammar and spelling</li>
                            <li><b>Translation</b> - Translate between languages</li>
                            <li><b>Summarize</b> - Create concise summaries</li>
                        </ul>
                    </li>
                </ul>
                <p>Is there something specific you need help with?</p>
            `);
        }
        
        // Show a random study tip
        function showRandomTip() {
            const tips = [
                "Try to create flashcards with simple, clear questions for the best results.",
                "Use spaced repetition - study hard cards more frequently than easier ones.",
                "Write answers in your own words to improve understanding and retention.",
                "Review your flashcards regularly, not just before exams.",
                "Try to create visual associations to help remember difficult concepts.",
                "Use our AI tools to help generate content or check your grammar.",
                "Organize your flashcards with tags for better organization.",
                "Test yourself actively rather than just reading through the cards.",
                "Study in short, focused sessions rather than long marathons.",
                "Combine your flashcards with other study methods for the best learning."
            ];
            
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            addBotMessage(`<p><b>Study Tip:</b> ${randomTip}</p>`);
        }
        
        // Show memory techniques
        function showMemoryTechniques() {
            addBotMessage(`
                <h6 class="mb-2">Effective Memory Techniques:</h6>
                <ul>
                    <li><b>Spaced Repetition</b> - Review information at increasing intervals</li>
                    <li><b>Memory Palace</b> - Associate information with locations in a familiar place</li>
                    <li><b>Chunking</b> - Break complex information into smaller, manageable units</li>
                    <li><b>Mnemonic Devices</b> - Create acronyms or phrases to remember information</li>
                    <li><b>Active Recall</b> - Test yourself instead of just reviewing</li>
                    <li><b>Visualization</b> - Create mental images to represent concepts</li>
                    <li><b>Teaching Others</b> - Explaining concepts helps solidify understanding</li>
                </ul>
                <p>Would you like more detailed information about any of these techniques?</p>
            `);
        }
        
        // Save message to chat history
        function saveToHistory(message) {
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // Add new message with timestamp
            history.unshift({
                message: message,
                timestamp: new Date().toISOString()
            });
            
            // Keep only the last 10 messages
            history = history.slice(0, 10);
            
            // Save back to localStorage
            localStorage.setItem('chatHistory', JSON.stringify(history));
            
            // Update the UI
            updateChatHistoryUI();
        }
        
        // Set up chat history from localStorage
        function setupChatHistory() {
            updateChatHistoryUI();
            
            // Add click event to history items
            chatHistory.addEventListener('click', function(e) {
                const item = e.target.closest('.list-group-item');
                if (item && item.dataset.message) {
                    chatInput.value = item.dataset.message;
                    chatInput.focus();
                }
            });
        }
        
        // Update chat history UI
        function updateChatHistoryUI() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            if (history.length === 0) {
                chatHistory.innerHTML = '<li class="list-group-item text-muted text-center">No previous chats</li>';
                return;
            }
            
            chatHistory.innerHTML = '';
            
            history.forEach(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleString(undefined, { 
                    hour: 'numeric', 
                    minute: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'list-group-item-action');
                li.setAttribute('data-message', item.message);
                
                // Truncate long messages
                const displayMessage = item.message.length > 25 
                    ? item.message.substring(0, 25) + '...' 
                    : item.message;
                
                li.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <p class="mb-1">${displayMessage}</p>
                        <small class="text-muted">${formattedDate}</small>
                    </div>
                `;
                
                chatHistory.appendChild(li);
            });
        }
    });
</script>
{% endblock %} 